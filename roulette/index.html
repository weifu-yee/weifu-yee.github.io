<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>餐廳轉盤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #wheel {
      width: 250px;
      height: 250px;
      border-radius: 50%;
      border: 6px solid #374151;
      position: relative;
      transition: transform 3s cubic-bezier(0.25, 1.5, 0.5, 1);
      transform-origin: center center;
    }
    .dot {
      width: 8px;
      height: 8px;
      background: #374151;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
    }
    #pointer {
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 20px solid #ef4444;
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }
    #map {
      width: 100%;
      height: 300px;
      margin-top: 1rem;
      border: 2px solid #ccc;
      border-radius: 0.5rem;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">
  <div class="flex flex-col md:flex-row w-full max-w-5xl gap-6">
    <div class="flex flex-col items-center flex-1">
      <h1 class="text-2xl font-bold mb-4">餐廳轉盤</h1>

      <!-- District selector -->
      <div id="districts" class="flex flex-wrap gap-2 mb-2"></div>
      <div class="w-full max-w-xl flex gap-2 mb-2">
        <input id="districtInput" type="text" class="flex-1 border rounded px-2 py-1" placeholder="例如：竹南鎮, 台中市中區, 嘉義縣" />
        <button id="addDistrictBtn" type="button" class="px-3 py-1 rounded bg-gray-700 text-white">新增</button>
      </div>

      <!-- TW region cascaded selects -->
      <div class="w-full max-w-xl flex flex-wrap items-center gap-2 mb-3">
        <select id="countySelect" class="border rounded px-2 py-1">
          <option value="">選擇縣市</option>
        </select>
        <select id="regionSelect" class="border rounded px-2 py-1" disabled>
          <option value="">選擇鄉鎮市區</option>
        </select>
        <button id="addRegionBtn" type="button" class="px-3 py-1 rounded border bg-gray-200">加入</button>
      </div>

      <div class="w-full max-w-xl flex items-center justify-between mb-2">
        <button id="toggleAdvanced" type="button" class="text-sm text-blue-600 underline">進階選項</button>
      </div>
      <div id="advancedPanel" class="hidden w-full max-w-xl mb-4 p-3 bg-white border rounded">
        <p class="text-sm font-semibold mb-2">勾選關鍵字（可複選）</p>
        <div id="keywordChecks" class="grid grid-cols-2 gap-2 mb-2"></div>
        <div class="flex justify-end mt-1">
          <button id="clearKeywordsBtn" type="button" class="text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-100">清除關鍵字選擇</button>
        </div>
        <label class="flex items-center gap-2">
          <input id="kwOther" type="checkbox" class="accent-blue-600" />
          <span>其他</span>
          <input id="kwOtherInput" type="text" class="flex-1 border rounded px-2 py-1" placeholder="英文逗號分隔：ramen, hotpot" disabled />
        </label>
        <div class="flex justify-end mt-1">
          <button id="clearKeywordsBtn" type="button" class="text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-100">清除關鍵字選擇</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">若未選擇，將使用所有內建關鍵字搜尋。</p>
        <div class="mt-2 grid grid-cols-2 gap-3 items-center">
          <div id="diceTitle" class="text-sm font-semibold">隨機選一個關鍵字</div>
          <label class="flex items-center gap-2">
            <input id="diceKeywords" type="checkbox" class="accent-blue-600" />
            <span>啟用</span>
          </label>
        </div>
        <!-- Cost range filter -->
        <div class="mt-3 grid grid-cols-2 gap-3 items-center">
          <label for="costMin" class="text-sm font-semibold">價格範圍</label>
          <div class="flex items-center gap-2">
            <select id="costMin" class="border rounded px-2 py-1">
              <option value="">不限</option>
              <option value="0">0 · 約 NT$0–100</option>
              <option value="1">1 · 約 NT$100–200</option>
              <option value="2">2 · 約 NT$200–400</option>
              <option value="3">3 · 約 NT$400–800</option>
              <option value="4">4 · 約 NT$800+</option>
            </select>
            <span class="text-sm">到</span>
            <select id="costMax" class="border rounded px-2 py-1">
              <option value="">不限</option>
              <option value="0">0 · 約 NT$0–100</option>
              <option value="1">1 · 約 NT$100–200</option>
              <option value="2">2 · 約 NT$200–400</option>
              <option value="3">3 · 約 NT$400–800</option>
              <option value="4">4 · 約 NT$800+</option>
            </select>
          </div>
        </div>
        <!-- Radius from my location -->
        <div class="mt-3 grid grid-cols-2 gap-3 items-center">
          <label class="text-sm font-semibold" for="useMyLocation">以目前位置為中心</label>
          <div class="flex items-center gap-2">
            <label class="flex items-center gap-2">
              <input id="useMyLocation" type="checkbox" class="accent-blue-600" />
              <span>啟用</span>
            </label>
            <input id="radiusKm" type="number" min="0.1" max="50" step="0.1" value="3" class="w-24 border rounded px-2 py-1" disabled />
            <span class="text-sm">公里</span>
          </div>
        </div>
        <hr class="my-3" />
        <div class="flex items-center gap-3">
          <label for="selectCount" class="text-sm font-semibold">欲選擇的餐廳數量</label>
          <input id="selectCount" type="number" min="2" max="36" value="20" class="w-24 border rounded px-2 py-1" />
          <span class="text-xs text-gray-500">(2–36，預設 20)</span>
        </div>

        <!-- Import Saved Lists (inside Advanced) -->
        <hr class="my-3" />
        <div class="flex flex-col gap-2">
          <div class="text-sm font-semibold">從 Google 地圖已儲存清單匯入</div>
          <div class="flex flex-wrap items-center gap-2">
            <input id="savedFiles" type="file" multiple accept=".json" class="hidden" />
            <button id="chooseSavedBtn" type="button" class="px-3 py-1 rounded bg-gray-700 text-white">選擇檔案</button>
            <button id="buildFromSavedBtn" type="button" class="px-3 py-1 rounded bg-green-600 text-white">用匯入地點建立</button>
            <span id="savedSummary" class="text-sm text-gray-600">尚未匯入</span>
          </div>
          <div class="text-xs text-gray-500">從 Google Takeout 匯出：Maps → Your places → Saved，下載並解壓後上傳 JSON。</div>
        </div>
      </div>

      <button onclick="fetchRestaurantsV2()" class="px-4 py-2 bg-green-500 text-white rounded shadow">取得餐廳</button>

      <div id="loadingBarOuter" class="w-full max-w-xl h-2 bg-gray-200 rounded mt-3 hidden">
        <div id="loadingBarInner" class="h-2 bg-blue-500 rounded w-0 transition-all duration-200"></div>
      </div>
      <div class="relative my-6" style="width:250px;height:250px;">
        <div id="pointer"></div>
        <div id="wheel" class="flex items-center justify-center text-xl font-bold">轉盤</div>
      </div>

      <button onclick="spin()" class="px-4 py-2 bg-red-500 text-white rounded shadow">開始轉盤</button>

      <div id="result" class="text-center mt-6"></div>
      <div id="map"></div>
    </div>

    <div class="w-full md:w-64 bg-white shadow rounded p-4 overflow-y-auto md:max-h-[500px]">
      <h2 class="text-lg font-bold mb-2">可選餐廳</h2>
      <ul id="restaurantList" class="list-disc list-inside text-gray-700 space-y-1"></ul>
    </div>
  </div>

  <script>
    // Default districts (edit this list to change defaults)
    const districts = ["新竹市", "竹北市"];
    const selected = new Set();
    let restaurants = [];
    let service, map, marker, geocoder;

    const colors = ["#f87171", "#60a5fa", "#34d399", "#fbbf24", "#a78bfa", "#f472b6"];

    // Keep keywords ASCII to avoid encoding issues
    const keywords = [
      "breakfast", "bbq", "ramen", "steak", "hotpot", "noodles", "snacks", "bar",
      "coffee", "dessert", "restaurant", "brunch", "vegetarian", "seafood", "bento",
      "fried", "light meal", "drinks", "pasta", "burger", "sushi", "night market"
    ];

    // Geocode bounds cache
    const boundsCache = {};

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // District buttons
    const districtDiv = document.getElementById("districts");
    function createDistrictButton(d) {
      const btn = document.createElement("button");
      btn.textContent = d;
      btn.className = "px-3 py-1 rounded border bg-gray-200";
      btn.onclick = () => {
        if (selected.has(d)) {
          selected.delete(d);
          btn.className = "px-3 py-1 rounded border bg-gray-200";
        } else {
          selected.add(d);
          btn.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        }
      };
      districtDiv.appendChild(btn);
    }
    districts.forEach(createDistrictButton);

    // Manual district adding
    const districtInputEl = document.getElementById("districtInput");
    const addDistrictBtn = document.getElementById("addDistrictBtn");
    addDistrictBtn.onclick = () => {
      const raw = (districtInputEl.value || '').trim();
      if (!raw) return;
      raw.split(',').map(s => s.trim()).filter(Boolean).forEach(name => {
        const exists = Array.from(districtDiv.querySelectorAll('button')).find(b => b.textContent === name);
        if (exists) {
          selected.add(name);
          exists.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        } else {
          createDistrictButton(name);
          selected.add(name);
          const lastBtn = Array.from(districtDiv.querySelectorAll('button')).pop();
          if (lastBtn && lastBtn.textContent === name) lastBtn.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        }
      });
      districtInputEl.value = '';
    };

    // Cascaded county -> district selection (Taiwan)
    const countySelect = document.getElementById('countySelect');
    const regionSelect = document.getElementById('regionSelect');
    const addRegionBtn = document.getElementById('addRegionBtn');

    const twRegions = {
      "台北市": ["中正區","大同區","中山區","松山區","大安區","萬華區","信義區","士林區","北投區","內湖區","南港區","文山區"],
      "新北市": ["板橋區","新莊區","泰山區","林口區","淡水區","金山區","八里區","萬里區","石門區","三芝區","瑞芳區","汐止區","平溪區","貢寮區","雙溪區","深坑區","石碇區","新店區","坪林區","烏來區","中和區","永和區","土城區","三峽區","樹林區","鶯歌區","三重區","蘆洲區","五股區"],
      "桃園市": ["桃園區","中壢區","平鎮區","八德區","楊梅區","蘆竹區","龜山區","龍潭區","大溪區","大園區","觀音區","新屋區","復興區"],
      "台中市": ["中區","東區","南區","西區","北區","北屯區","西屯區","南屯區","太平區","大里區","霧峰區","烏日區","豐原區","后里區","石岡區","東勢區","新社區","和平區","神岡區","潭子區","大雅區","大肚區","沙鹿區","龍井區","梧棲區","清水區","大甲區","外埔區","大安區"],
      "台南市": ["中西區","東區","南區","北區","安平區","安南區","永康區","歸仁區","新化區","左鎮區","玉井區","楠西區","南化區","仁德區","關廟區","龍崎區","官田區","麻豆區","佳里區","西港區","七股區","將軍區","學甲區","北門區","新營區","後壁區","白河區","東山區","六甲區","下營區","柳營區","鹽水區","善化區","大內區","山上區","新市區","安定區"],
      "高雄市": ["楠梓區","左營區","鼓山區","三民區","鹽埕區","前金區","新興區","苓雅區","前鎮區","小港區","旗津區","鳳山區","大寮區","鳥松區","林園區","仁武區","大樹區","大社區","岡山區","路竹區","橋頭區","梓官區","彌陀區","永安區","燕巢區","田寮區","阿蓮區","湖內區","茄萣區","旗山區","美濃區","六龜區","內門區","杉林區","甲仙區","桃源區","那瑪夏區","茂林區"],
      "基隆市": ["仁愛區","信義區","中正區","中山區","安樂區","暖暖區","七堵區"],
      "新竹市": ["東區","北區","香山區"],
      "新竹縣": ["竹北市","竹東鎮","新埔鎮","關西鎮","湖口鄉","新豐鄉","芎林鄉","橫山鄉","北埔鄉","寶山鄉","峨眉鄉","尖石鄉","五峰鄉"],
      "苗栗縣": ["苗栗市","頭份市","苑裡鎮","通霄鎮","竹南鎮","後龍鎮","卓蘭鎮","大湖鄉","公館鄉","銅鑼鄉","南庄鄉","頭屋鄉","三義鄉","西湖鄉","造橋鄉","三灣鄉","獅潭鄉","泰安鄉"],
      "彰化縣": ["彰化市","鹿港鎮","和美鎮","線西鄉","伸港鄉","福興鄉","秀水鄉","花壇鄉","芬園鄉","員林市","溪湖鎮","田中鎮","大村鄉","埔鹽鄉","埔心鄉","永靖鄉","社頭鄉","二水鄉","北斗鎮","二林鎮","田尾鄉","埤頭鄉","芳苑鄉","大城鄉","竹塘鄉","溪州鄉"],
      "南投縣": ["南投市","埔里鎮","草屯鎮","竹山鎮","集集鎮","名間鄉","鹿谷鄉","中寮鄉","魚池鄉","國姓鄉","水里鄉","信義鄉","仁愛鄉"],
      "雲林縣": ["斗六市","斗南鎮","虎尾鎮","西螺鎮","土庫鎮","北港鎮","莿桐鄉","林內鄉","二崙鄉","崙背鄉","麥寮鄉","東勢鄉","褒忠鄉","臺西鄉","元長鄉","四湖鄉","口湖鄉","水林鄉"],
      "嘉義市": ["東區","西區"],
      "嘉義縣": ["太保市","朴子市","布袋鎮","大林鎮","民雄鄉","溪口鄉","新港鄉","六腳鄉","東石鄉","義竹鄉","鹿草鄉","水上鄉","中埔鄉","竹崎鄉","梅山鄉","番路鄉","大埔鄉","阿里山鄉"],
      "宜蘭縣": ["宜蘭市","羅東鎮","蘇澳鎮","頭城鎮","礁溪鄉","壯圍鄉","五結鄉","冬山鄉","三星鄉","大同鄉","南澳鄉"],
      "屏東縣": ["屏東市","潮州鎮","東港鎮","恆春鎮","萬丹鄉","長治鄉","麟洛鄉","九如鄉","里港鄉","鹽埔鄉","高樹鄉","萬巒鄉","內埔鄉","竹田鄉","新埤鄉","枋寮鄉","新園鄉","崁頂鄉","林邊鄉","南州鄉","佳冬鄉","琉球鄉","車城鄉","枋山鄉","春日鄉","獅子鄉","牡丹鄉","三地門鄉","瑪家鄉","泰武鄉","來義鄉"],
      "花蓮縣": ["花蓮市","鳳林鎮","玉里鎮","新城鄉","吉安鄉","壽豐鄉","光復鄉","豐濱鄉","瑞穗鄉","富里鄉","秀林鄉","萬榮鄉","卓溪鄉"],
      "台東縣": ["台東市","成功鎮","關山鎮","卑南鄉","鹿野鄉","池上鄉","東河鄉","長濱鄉","太麻里鄉","大武鄉","綠島鄉","海端鄉","延平鄉","金峰鄉","達仁鄉","蘭嶼鄉"],
      "澎湖縣": ["馬公市","湖西鄉","白沙鄉","西嶼鄉","望安鄉","七美鄉"],
      "金門縣": ["金城鎮","金沙鎮","金湖鎮","金寧鄉","烈嶼鄉","烏坵鄉"],
      "連江縣": ["南竿鄉","北竿鄉","莒光鄉","東引鄉"]
    };

    // Populate county select
    if (countySelect) {
      Object.keys(twRegions).forEach(k => {
        const opt = document.createElement('option'); opt.value = k; opt.textContent = k; countySelect.appendChild(opt);
      });
    }
    if (countySelect && regionSelect) {
      countySelect.addEventListener('change', () => {
        const k = countySelect.value;
        regionSelect.innerHTML = '';
        const def = document.createElement('option'); def.value=''; def.textContent='選擇鄉鎮市區'; regionSelect.appendChild(def);
        if (k && twRegions[k]) {
          twRegions[k].forEach(r => { const o=document.createElement('option'); o.value=r; o.textContent=r; regionSelect.appendChild(o); });
          regionSelect.disabled = false;
        } else {
          regionSelect.disabled = true;
        }
      });
    }
    if (addRegionBtn) {
      addRegionBtn.onclick = () => {
        const c = countySelect && countySelect.value ? countySelect.value : '';
        const r = regionSelect && regionSelect.value ? regionSelect.value : '';
        if (!c || !r) return;
        const full = `${c} ${r}`;
        const exists = Array.from(districtDiv.querySelectorAll('button')).find(b => b.textContent === full);
        if (exists) {
          selected.add(full);
          exists.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        } else {
          createDistrictButton(full);
          selected.add(full);
          const lastBtn = Array.from(districtDiv.querySelectorAll('button')).pop();
          if (lastBtn && lastBtn.textContent === full) lastBtn.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        }
      };
    }

    // Advanced options: keyword checks
    const toggleAdvancedBtn = document.getElementById("toggleAdvanced");
    const advancedPanel = document.getElementById("advancedPanel");
    const keywordChecksEl = document.getElementById("keywordChecks");
    const diceKeywordsEl = document.getElementById("diceKeywords");
    const costMinEl = document.getElementById("costMin");
    const costMaxEl = document.getElementById("costMax");
    const useMyLocationEl = document.getElementById("useMyLocation");
    const radiusKmEl = document.getElementById("radiusKm");
    // Ensure only one clear button exists (move effect)
    (function(){
      const nodes = document.querySelectorAll('#clearKeywordsBtn');
      if (nodes.length > 1) {
        for (let i = 0; i < nodes.length - 1; i++) {
          const n = nodes[i];
          if (n && n.parentElement) {
            n.parentElement.remove();
          } else if (n) {
            n.remove();
          }
        }
      }
    })();
    const clearKeywordsBtn = document.getElementById("clearKeywordsBtn");
    // Dice title uses normal section label styling now
    const kwOtherEl = document.getElementById("kwOther");
    const kwOtherInputEl = document.getElementById("kwOtherInput");
    const selectCountEl = document.getElementById("selectCount");
    toggleAdvancedBtn.onclick = () => advancedPanel.classList.toggle("hidden");
    kwOtherEl.onchange = () => { kwOtherInputEl.disabled = !kwOtherEl.checked; };
    if (useMyLocationEl && radiusKmEl) {
      useMyLocationEl.onchange = () => {
        const on = !!useMyLocationEl.checked;
        radiusKmEl.disabled = !on;
        // Toggle district UI availability
        if (districtInputEl) districtInputEl.disabled = on;
        if (addDistrictBtn) addDistrictBtn.disabled = on;
        if (districtDiv) {
          if (on) {
            // Clear all selected districts and reset button styles
            selected.clear();
            districtDiv.querySelectorAll('button').forEach(btn => btn.className = "px-3 py-1 rounded border bg-gray-200");
            districtDiv.classList.add('opacity-50','pointer-events-none');
          } else {
            districtDiv.classList.remove('opacity-50','pointer-events-none');
          }
        }
        if (countySelect) countySelect.disabled = on;
        if (regionSelect) regionSelect.disabled = on || !(countySelect && countySelect.value);
        if (addRegionBtn) addRegionBtn.disabled = on;
      };
    }
    if (clearKeywordsBtn) {
      clearKeywordsBtn.onclick = () => {
        keywordChecksEl.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
        kwOtherEl.checked = false; kwOtherInputEl.value = ''; kwOtherInputEl.disabled = true;
      };
    }

    function renderKeywordChecks() {
      keywordChecksEl.innerHTML = "";
      const uniq = Array.from(new Set(keywords));
      uniq.forEach((k, idx) => {
        const label = document.createElement("label");
        label.className = "flex items-center gap-2";
        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.value = k; cb.id = `kw_${idx}`; cb.className = "accent-blue-600";
        const span = document.createElement("span"); span.textContent = k;
        label.appendChild(cb); label.appendChild(span);
        keywordChecksEl.appendChild(label);
      });
    }
    renderKeywordChecks();

    function getActiveKeywords() {
      const picked = [];
      keywordChecksEl.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => picked.push(cb.value));
      if (kwOtherEl.checked && kwOtherInputEl.value.trim()) {
        const extras = kwOtherInputEl.value.split(',').map(s => s.trim()).filter(Boolean);
        picked.push(...extras);
      }
      const pool = picked.length ? picked : keywords;
      if (diceKeywordsEl && diceKeywordsEl.checked && pool.length) {
        const one = pool[Math.floor(Math.random() * pool.length)];
        return [one];
      }
      return pool;
    }

    function getPriceRange() {
      const min = costMinEl && costMinEl.value !== '' ? parseInt(costMinEl.value, 10) : null;
      const max = costMaxEl && costMaxEl.value !== '' ? parseInt(costMaxEl.value, 10) : null;
      if (min === null && max === null) return null;
      if (min !== null && max === null) return { min, max: min };
      if (min === null && max !== null) return { min: max, max };
      if (min > max) return { min: max, max: min };
      return { min, max };
    }

    function getRadiusMeters() {
      const v = parseFloat((radiusKmEl && radiusKmEl.value) || '3');
      if (Number.isNaN(v)) return 3000;
      const km = Math.min(50, Math.max(0.1, v));
      return Math.round(km * 1000);
    }

    function getSelectCount() {
      const v = parseInt((selectCountEl && selectCountEl.value) || '20', 10);
      if (Number.isNaN(v)) return 20;
      return Math.max(2, Math.min(36, v));
    }

    // Loading bar helpers
    let loadingTimer = null, loadingStart = 0, loadingDuration = 0;
    function beginLoading(totalMs) {
      const outer = document.getElementById('loadingBarOuter');
      const inner = document.getElementById('loadingBarInner');
      if (!outer || !inner) return;
      outer.classList.remove('hidden');
      inner.style.width = '0%';
      if (loadingTimer) clearInterval(loadingTimer);
      loadingStart = Date.now();
      loadingDuration = Math.max(500, Math.floor(totalMs || 3000));
      loadingTimer = setInterval(() => {
        const elapsed = Date.now() - loadingStart;
        const pct = Math.min(99, Math.floor(elapsed / loadingDuration * 100));
        inner.style.width = pct + '%';
        if (pct >= 99) { clearInterval(loadingTimer); loadingTimer = null; }
      }, 120);
    }
    function finishLoading() {
      const outer = document.getElementById('loadingBarOuter');
      const inner = document.getElementById('loadingBarInner');
      if (!outer || !inner) return;
      if (loadingTimer) { clearInterval(loadingTimer); loadingTimer = null; }
      inner.style.width = '100%';
      setTimeout(() => { outer.classList.add('hidden'); inner.style.width = '0%'; }, 400);
    }

    // Decorative dots
    const wheel = document.getElementById("wheel");
    const dotCount = 36, radius = 120;
    for (let i = 0; i < dotCount; i++) {
      const angle = (2 * Math.PI / dotCount) * i;
      const dot = document.createElement("div");
      dot.className = "dot";
      dot.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*radius}px, ${Math.sin(angle)*radius}px)`;
      wheel.appendChild(dot);
    }

    // Maps init
    function initApp() {
      const tempMap = new google.maps.Map(document.createElement("div"));
      service = new google.maps.places.PlacesService(tempMap);
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("map"), { center: { lat: 24.8138, lng: 120.9675 }, zoom: 12 });
      marker = new google.maps.Marker({ map });
    }

    function geocodeDistrict(name) {
      return new Promise((resolve) => {
        if (boundsCache[name]) return resolve(boundsCache[name]);
        geocoder.geocode({ address: `${name}, 台灣` }, (results, status) => {
          if (status === google.maps.GeocoderStatus.OK && results && results[0]) {
            const g = results[0].geometry;
            const out = { bounds: g.bounds || g.viewport || null, center: g.location };
            boundsCache[name] = out;
            resolve(out);
          } else {
            resolve(null);
          }
        });
      });
    }

    function fetchRestaurantsV2() {
      restaurants = [];
      document.getElementById("restaurantList").innerHTML = "";
      const usingMyLoc = !!(useMyLocationEl && useMyLocationEl.checked);
      if (usingMyLoc) { try { selected.add('__MY_LOC__'); } catch (e) {} }
      if (selected.size === 0) { alert("請先選擇至少一個地區"); return; }
      const pool = getActiveKeywords();
      if (!pool.length) { alert("請輸入至少一個關鍵字"); return; }

      const priceRange = getPriceRange();
      if (usingMyLoc) {
        if (!navigator.geolocation) { alert('此瀏覽器不支援定位'); return; }
        navigator.geolocation.getCurrentPosition((pos) => {
          const center = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          map.setCenter(center);
          marker.setPosition(center);
          const usedKwsSet = new Set();
          const seen = new Set();
          let done = 0;
          const tasks = [];
          const totalMs = Math.round(5000 * (getSelectCount() / 20));
          if (typeof beginLoading === 'function') beginLoading(totalMs);
          pool.forEach(kw => { tasks.push({ kw }); usedKwsSet.add(kw); });
          tasks.forEach(({ kw }) => {
            const req = { location: center, radius: getRadiusMeters(), type: 'restaurant', keyword: kw };
            if (priceRange) { req.minPriceLevel = priceRange.min; req.maxPriceLevel = priceRange.max; }
            service.nearbySearch(req, (results, status, pagination) => {
              if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results)) {
                for (const r of results) {
                  if (priceRange && typeof r.price_level === 'number') {
                    if (r.price_level < priceRange.min || r.price_level > priceRange.max) continue;
                  }
                  if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
                }
              }
              if (pagination && pagination.hasNextPage) {
                setTimeout(() => pagination.nextPage(), 300);
              } else {
                if ((!results || results.length === 0)) {
                  const tReq = { query: `${kw} restaurant`, location: center, radius: getRadiusMeters(), region: 'TW' };
                  if (priceRange) { tReq.minPriceLevel = priceRange.min; tReq.maxPriceLevel = priceRange.max; }
                  service.textSearch(tReq, (tRes, tStatus) => {
                    if (tStatus === google.maps.places.PlacesServiceStatus.OK && Array.isArray(tRes)) {
                      for (const r of tRes) {
                        if (priceRange && typeof r.price_level === 'number') {
                          if (r.price_level < priceRange.min || r.price_level > priceRange.max) continue;
                        }
                        if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
                      }
                    }
                    finalize();
                  });
                } else {
                  finalize();
                }
              }
              function finalize() {
                if (typeof finishLoading === 'function') finishLoading();
                if (++done === tasks.length) {
                  shuffle(restaurants);
                  const count = (typeof getSelectCount === 'function') ? getSelectCount() : 20;
                  restaurants = restaurants.slice(0, Math.max(1, Math.min(count, restaurants.length)));
                  assignSlicesAndColors();
                  const usedKws = Array.from(usedKwsSet);
                  const kwText = usedKws.length ? usedKws.join(', ') : 'default';
                  alert(`本次候選：${restaurants.length} 家\n關鍵字：${kwText}`);
                }
              }
            });
          });
        }, (err) => { alert('定位失敗：' + (err && err.message ? err.message : 'unknown')); }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 30000 });
        return;
      }
      const tasks = [];
      const usedKwsSet = new Set();
      const totalMs = Math.round(5000 * (getSelectCount() / 20));
      if (typeof beginLoading === 'function') beginLoading(totalMs);
      Array.from(selected).forEach(d => pool.forEach(kw => { tasks.push({ d, kw }); usedKwsSet.add(kw); }));

      const seen = new Set();
      let done = 0;
      tasks.forEach(({ d, kw }) => {
        geocodeDistrict(d).then(info => {
          const center = info && info.center ? info.center : null;
          const bounds = info && info.bounds ? info.bounds : null;

          if (!center) {
            const query = `${kw} restaurant ${d}`;
            service.textSearch({ query, region: 'TW' }, (tRes, tStatus) => {
              if (tStatus === google.maps.places.PlacesServiceStatus.OK && Array.isArray(tRes)) {
                for (const r of tRes) {
                  if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
                }
              }
              if (++done === tasks.length) finalizeWheel();
            });
            return;
          }

          const req = { location: center, radius: 6000, type: 'restaurant', keyword: kw };
          if (typeof getPriceRange === 'function') {
            const pr = getPriceRange();
            if (pr) { req.minPriceLevel = pr.min; req.maxPriceLevel = pr.max; }
          }
          service.nearbySearch(req, (results, status, pagination) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results)) {
              for (const r of results) {
                const pr = (typeof getPriceRange === 'function') ? getPriceRange() : null;
                if (pr && typeof r.price_level === 'number') {
                  if (r.price_level < pr.min || r.price_level > pr.max) continue;
                }
                const inside = !bounds || (r.geometry && r.geometry.location && bounds.contains(r.geometry.location));
                if (!inside) continue;
                if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
              }
            }
            if (pagination && pagination.hasNextPage) {
              setTimeout(() => pagination.nextPage(), 300);
            } else {
              if ((!results || results.length === 0)) {
                const query = `${kw} restaurant ${d}`;
                const tReq = { query, location: center, radius: 6000, region: 'TW' };
                const pr2 = (typeof getPriceRange === 'function') ? getPriceRange() : null;
                if (pr2) { tReq.minPriceLevel = pr2.min; tReq.maxPriceLevel = pr2.max; }
                service.textSearch(tReq, (tRes, tStatus) => {
                  if (tStatus === google.maps.places.PlacesServiceStatus.OK && Array.isArray(tRes)) {
                    for (const r of tRes) {
                      if (pr2 && typeof r.price_level === 'number') {
                        if (r.price_level < pr2.min || r.price_level > pr2.max) continue;
                      }
                      const inside2 = !bounds || (r.geometry && r.geometry.location && bounds.contains(r.geometry.location));
                      if (!inside2) continue;
                      if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
                    }
                  }
                  if (++done === tasks.length) finalizeWheel();
                });
              } else {
                if (++done === tasks.length) finalizeWheel();
              }
            }
          });
        }).catch(() => { if (++done === tasks.length) finalizeWheel(); });
      });

      function finalizeWheel() {
        if (typeof finishLoading === 'function') finishLoading();
        shuffle(restaurants);
        const count = (typeof getSelectCount === 'function') ? getSelectCount() : 20;
        restaurants = restaurants.slice(0, Math.max(1, Math.min(count, restaurants.length)));
        assignSlicesAndColors();
        const usedKws = Array.from(usedKwsSet);
        const kwText = usedKws.length ? usedKws.join(', ') : 'default';
        alert(`找到可選餐廳: ${restaurants.length} 家\n關鍵字: ${kwText}`);
      }
    }

    function assignSlicesAndColors() {
      if (!restaurants.length) return;
      const slice = 360 / restaurants.length;
      const list = document.getElementById("restaurantList");
      list.innerHTML = "";
      const parts = [];
      restaurants.forEach((r, i) => {
        const color = colors[i % colors.length];
        const startAngle = i * slice, endAngle = (i + 1) * slice;
        r._color = color; r._sliceStart = startAngle; r._sliceEnd = endAngle; r._sliceCenter = startAngle + slice / 2;
        parts.push(`${color} ${startAngle}deg ${endAngle}deg`);
        const li = document.createElement("li"); li.textContent = r.name; list.appendChild(li);
      });
      wheel.style.background = `conic-gradient(${parts.join(',')})`;
    }

    function spin() {
      if (!restaurants.length) { alert("請先取得餐廳"); return; }
      const r = restaurants[Math.floor(Math.random() * restaurants.length)];
      const targetDeg = 3600 + (360 - r._sliceCenter);
      wheel.style.transform = `rotate(${targetDeg}deg)`;
      setTimeout(() => {
        const url = r.place_id ? `https://www.google.com/maps/place/?q=place_id:${r.place_id}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name)}`;
        document.getElementById("result").innerHTML = `
          <h2 class="text-xl font-bold" style="color:${r._color};">${r.name}</h2>
          <p>${r.vicinity || r.formatted_address || ''}</p>
          <a href="${url}" target="_blank" class="text-blue-600 underline">在 Google 地圖開啟</a>`;
        showOnMap(r);
      }, 3200);
    }

    function showOnMap(place) {
      if (!place.geometry || !place.geometry.location) return;
      map.setCenter(place.geometry.location);
      marker.setPosition(place.geometry.location);
      marker.setTitle(place.name);
    }
  </script>


  <script>
    // Import Google Maps Saved lists (Google Takeout JSON)
    let importedSaved = [];
    let importedListsMeta = [];

    function parseSavedJson(json, fileName) {
      const out = [];
      if (Array.isArray(json)) {
        for (const item of json) {
          const name = item.title || item.name || (item.properties && (item.properties.Name || item.properties.name || item.properties.title)) || '';
          const url = item.googleMapsUrl || item.url || (item.properties && (item.properties.GoogleMapsURL || item.properties.googleMapsUrl)) || '';
          const loc = item.location || item.coordinates || item.geo || item.geometry;
          let lat, lng;
          if (loc && typeof loc === 'object') {
            if (typeof loc.latitude === 'number' && typeof loc.longitude === 'number') { lat = loc.latitude; lng = loc.longitude; }
            else if (typeof loc.lat === 'number' && typeof loc.lng === 'number') { lat = loc.lat; lng = loc.lng; }
            else if (Array.isArray(loc) && loc.length >= 2) { lat = loc[1]; lng = loc[0]; }
            else if (loc.type === 'Point' && Array.isArray(loc.coordinates)) { lng = loc.coordinates[0]; lat = loc.coordinates[1]; }
          }
          let placeId = null;
          if (typeof url === 'string') {
            const m = url.match(/place_id:([A-Za-z0-9_-]+)/);
            if (m) placeId = m[1];
          }
          if (name || placeId || (lat != null && lng != null)) {
            out.push({ name, place_id: placeId || null, lat, lng });
          }
        }
      } else if (json && typeof json === 'object') {
        if (Array.isArray(json.features)) {
          for (const f of json.features) {
            const name = (f.properties && (f.properties.name || f.properties.Name || f.properties.title)) || '';
            const url = (f.properties && (f.properties.googleMapsUrl || f.properties.GoogleMapsURL)) || '';
            let lat, lng;
            if (f.geometry && f.geometry.type === 'Point' && Array.isArray(f.geometry.coordinates)) {
              lng = f.geometry.coordinates[0]; lat = f.geometry.coordinates[1];
            }
            let placeId = null;
            if (typeof url === 'string') {
              const m = url.match(/place_id:([A-Za-z0-9_-]+)/);
              if (m) placeId = m[1];
            }
            if (name || placeId || (lat != null && lng != null)) {
              out.push({ name, place_id: placeId || null, lat, lng });
            }
          }
        }
      }
      importedListsMeta.push({ fileName, count: out.length });
      importedSaved.push(...out);
    }

    function summarizeSaved() {
      const el = document.getElementById('savedSummary');
      if (!el) return;
      const total = importedSaved.length;
      if (!total) { el.textContent = 'No places imported yet.'; return; }
      const lines = importedListsMeta.map(m => `${m.fileName}: ${m.count}`).join(', ');
      el.textContent = `Imported places: ${total} (${lines})`;
    }

    function wireSavedImport() {
      const input = document.getElementById('savedFiles');
      const chooseBtn = document.getElementById('chooseSavedBtn');
      const btn = document.getElementById('buildFromSavedBtn');
      if (chooseBtn && input) {
        chooseBtn.addEventListener('click', () => input.click());
      }
      if (input) {
        input.addEventListener('change', async (e) => {
          importedSaved = [];
          importedListsMeta = [];
          const files = Array.from(e.target.files || []);
          for (const f of files) {
            try {
              const text = await f.text();
              const json = JSON.parse(text);
              parseSavedJson(json, f.name);
            } catch (err) {
              console.warn('Failed to parse', f.name, err);
            }
          }
          summarizeSaved();
        });
      }
      if (btn) btn.addEventListener('click', buildFromSaved);
    }

    async function buildFromSaved() {
      if (!importedSaved.length) { alert('Please import Saved lists JSON files first.'); return; }
      if (!window.service) { alert('Maps not ready yet.'); return; }
      restaurants = [];
      const seen = new Set();
      const priceRange = (typeof getPriceRange === 'function') ? getPriceRange() : null;

      const candidates = importedSaved.slice(0);
      const totalMs = Math.round(3000 + 80 * candidates.length);
      if (typeof beginLoading === 'function') beginLoading(totalMs);

      let done = 0;
      function maybeFinish() {
        done++;
        if (done >= candidates.length) {
          if (typeof finishLoading === 'function') finishLoading();
          if (priceRange) {
            restaurants = restaurants.filter(r => typeof r.price_level !== 'number' || (r.price_level >= priceRange.min && r.price_level <= priceRange.max));
          }
          shuffle(restaurants);
          const count = (typeof getSelectCount === 'function') ? getSelectCount() : 20;
          restaurants = restaurants.slice(0, Math.max(1, Math.min(count, restaurants.length)));
          assignSlicesAndColors();
          alert(`Added ${restaurants.length} from saved lists.`);
        }
      }

      for (const item of candidates) {
        if (item.place_id) {
          window.service.getDetails({ placeId: item.place_id, fields: ['place_id','name','geometry','vicinity','formatted_address','types','price_level'] }, (res, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && res) {
              if (!seen.has(res.place_id)) {
                seen.add(res.place_id);
                if (!res.types || res.types.includes('restaurant') || res.types.includes('food') || res.types.includes('cafe') || res.types.includes('bar')) {
                  restaurants.push(res);
                }
              }
            }
            maybeFinish();
          });
        } else if (item.name && (item.lat != null && item.lng != null)) {
          const loc = new google.maps.LatLng(item.lat, item.lng);
          const req = { query: item.name, location: loc, radius: 800, region: 'TW', type: 'restaurant' };
          window.service.textSearch(req, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results) && results.length) {
              for (const r of results) {
                if (r.place_id && !seen.has(r.place_id)) {
                  seen.add(r.place_id);
                  restaurants.push(r);
                  break;
                }
              }
            }
            maybeFinish();
          });
        } else if (item.name) {
          window.service.textSearch({ query: item.name, region: 'TW', type: 'restaurant' }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results) && results.length) {
              const r = results[0];
              if (r.place_id && !seen.has(r.place_id)) {
                seen.add(r.place_id);
                restaurants.push(r);
              }
            }
            maybeFinish();
          });
        } else {
          maybeFinish();
        }
      }
    }

    document.addEventListener('DOMContentLoaded', wireSavedImport);
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHJAKYPP4peYR5TIVm69256nqJ01gat9Q&libraries=places&callback=initApp"></script>
</body>
</html>
