<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>餐廳轉盤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #wheel {
      width: 250px;
      height: 250px;
      border-radius: 50%;
      border: 6px solid #374151;
      position: relative;
      transition: transform 3s cubic-bezier(0.25, 1.5, 0.5, 1);
      transform-origin: center center;
    }
    .dot {
      width: 8px;
      height: 8px;
      background: #374151;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
    }
    #pointer {
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 20px solid #ef4444;
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
    }
    #map {
      width: 100%;
      height: 300px;
      margin-top: 1rem;
      border: 2px solid #ccc;
      border-radius: 0.5rem;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-6">
  <div class="flex w-full max-w-5xl gap-6">
    <div class="flex flex-col items-center flex-1">
      <h1 class="text-2xl font-bold mb-4">餐廳轉盤</h1>

      <!-- District selector -->
      <div id="districts" class="flex flex-wrap gap-2 mb-2"></div>
      <div class="w-full max-w-xl flex gap-2 mb-2">
        <input id="districtInput" type="text" class="flex-1 border rounded px-2 py-1" placeholder="例如：竹南鎮, 台中市中區, 嘉義縣" />
        <button id="addDistrictBtn" type="button" class="px-3 py-1 rounded bg-gray-700 text-white">新增</button>
      </div>

      <div class="w-full max-w-xl flex items-center justify-between mb-2">
        <button id="toggleAdvanced" type="button" class="text-sm text-blue-600 underline">進階選項</button>
      </div>
      <div id="advancedPanel" class="hidden w-full max-w-xl mb-4 p-3 bg-white border rounded">
        <p class="text-sm font-semibold mb-2">勾選關鍵字（可複選）</p>
        <div id="keywordChecks" class="grid grid-cols-2 gap-2 mb-2"></div>
        <div class="flex justify-end mt-1">
          <button id="clearKeywordsBtn" type="button" class="text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-100">清除關鍵字選擇</button>
        </div>
        <label class="flex items-center gap-2">
          <input id="kwOther" type="checkbox" class="accent-blue-600" />
          <span>其他</span>
          <input id="kwOtherInput" type="text" class="flex-1 border rounded px-2 py-1" placeholder="英文逗號分隔：ramen, hotpot" disabled />
        </label>
        <label class="flex items-center gap-2 mt-2">
          <input id="diceKeywords" type="checkbox" class="accent-blue-600" />
          <span>隨機選一個關鍵字</span>
        </label>
        <p class="text-xs text-gray-500 mt-2">若未選擇，將從內建關鍵字中隨機挑選。</p>
        <hr class="my-3" />
        <div class="flex items-center gap-3">
          <label for="selectCount" class="text-sm font-semibold">欲選擇的餐廳數量</label>
          <input id="selectCount" type="number" min="2" max="36" value="20" class="w-24 border rounded px-2 py-1" />
          <span class="text-xs text-gray-500">(2–36，預設 20)</span>
        </div>
      </div>

      <button onclick="fetchRestaurantsV2()" class="px-4 py-2 bg-green-500 text-white rounded shadow">取得餐廳</button>

      <div class="relative my-6" style="width:250px;height:250px;">
        <div id="pointer"></div>
        <div id="wheel" class="flex items-center justify-center text-xl font-bold">轉盤</div>
      </div>

      <button onclick="spin()" class="px-4 py-2 bg-red-500 text-white rounded shadow">開始轉盤</button>

      <div id="result" class="text-center mt-6"></div>
      <div id="map"></div>
    </div>

    <div class="w-64 bg-white shadow rounded p-4 overflow-y-auto max-h-[500px]">
      <h2 class="text-lg font-bold mb-2">可選餐廳</h2>
      <ul id="restaurantList" class="list-disc list-inside text-gray-700 space-y-1"></ul>
    </div>
  </div>

  <script>
    // Default districts (edit this list to change defaults)
    const districts = ["新竹市", "竹北市"];
    const selected = new Set();
    let restaurants = [];
    let service, map, marker, geocoder;

    const colors = ["#f87171", "#60a5fa", "#34d399", "#fbbf24", "#a78bfa", "#f472b6"];

    // Keep keywords ASCII to avoid encoding issues
    const keywords = [
      "breakfast", "bbq", "ramen", "steak", "hotpot", "noodles", "snacks", "bar",
      "coffee", "dessert", "restaurant", "brunch", "vegetarian", "seafood", "bento",
      "fried", "light meal", "drinks", "pasta", "burger", "sushi", "night market"
    ];

    // Geocode bounds cache
    const boundsCache = {};

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // District buttons
    const districtDiv = document.getElementById("districts");
    function createDistrictButton(d) {
      const btn = document.createElement("button");
      btn.textContent = d;
      btn.className = "px-3 py-1 rounded border bg-gray-200";
      btn.onclick = () => {
        if (selected.has(d)) {
          selected.delete(d);
          btn.className = "px-3 py-1 rounded border bg-gray-200";
        } else {
          selected.add(d);
          btn.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        }
      };
      districtDiv.appendChild(btn);
    }
    districts.forEach(createDistrictButton);

    // Manual district adding
    const districtInputEl = document.getElementById("districtInput");
    const addDistrictBtn = document.getElementById("addDistrictBtn");
    addDistrictBtn.onclick = () => {
      const raw = (districtInputEl.value || '').trim();
      if (!raw) return;
      raw.split(',').map(s => s.trim()).filter(Boolean).forEach(name => {
        const exists = Array.from(districtDiv.querySelectorAll('button')).find(b => b.textContent === name);
        if (exists) {
          selected.add(name);
          exists.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        } else {
          createDistrictButton(name);
          selected.add(name);
          const lastBtn = Array.from(districtDiv.querySelectorAll('button')).pop();
          if (lastBtn && lastBtn.textContent === name) lastBtn.className = "px-3 py-1 rounded border bg-blue-500 text-white";
        }
      });
      districtInputEl.value = '';
    };

    // Advanced options: keyword checks
    const toggleAdvancedBtn = document.getElementById("toggleAdvanced");
    const advancedPanel = document.getElementById("advancedPanel");
    const keywordChecksEl = document.getElementById("keywordChecks");
    const diceKeywordsEl = document.getElementById("diceKeywords");
    const clearKeywordsBtn = document.getElementById("clearKeywordsBtn");
    // Style the dice keyword label differently
    (function(){
      if (!diceKeywordsEl) return;
      const span = diceKeywordsEl.parentElement && diceKeywordsEl.parentElement.querySelector('span');
      if (span) {
        span.classList.add('text-purple-700','font-semibold');
        // Update wording for clarity
        span.textContent = '隨機選一個關鍵字';
      }
    })();
    const kwOtherEl = document.getElementById("kwOther");
    const kwOtherInputEl = document.getElementById("kwOtherInput");
    const selectCountEl = document.getElementById("selectCount");
    toggleAdvancedBtn.onclick = () => advancedPanel.classList.toggle("hidden");
    kwOtherEl.onchange = () => { kwOtherInputEl.disabled = !kwOtherEl.checked; };
    if (clearKeywordsBtn) {
      clearKeywordsBtn.onclick = () => {
        keywordChecksEl.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
        kwOtherEl.checked = false; kwOtherInputEl.value = ''; kwOtherInputEl.disabled = true;
      };
    }

    function renderKeywordChecks() {
      keywordChecksEl.innerHTML = "";
      const uniq = Array.from(new Set(keywords));
      uniq.forEach((k, idx) => {
        const label = document.createElement("label");
        label.className = "flex items-center gap-2";
        const cb = document.createElement("input");
        cb.type = "checkbox"; cb.value = k; cb.id = `kw_${idx}`; cb.className = "accent-blue-600";
        const span = document.createElement("span"); span.textContent = k;
        label.appendChild(cb); label.appendChild(span);
        keywordChecksEl.appendChild(label);
      });
    }
    renderKeywordChecks();

    function getActiveKeywords() {
      const picked = [];
      keywordChecksEl.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => picked.push(cb.value));
      if (kwOtherEl.checked && kwOtherInputEl.value.trim()) {
        const extras = kwOtherInputEl.value.split(',').map(s => s.trim()).filter(Boolean);
        picked.push(...extras);
      }
      const pool = picked.length ? picked : keywords;
      if (diceKeywordsEl && diceKeywordsEl.checked && pool.length) {
        const one = pool[Math.floor(Math.random() * pool.length)];
        return [one];
      }
      return pool;
    }

    function getSelectCount() {
      const v = parseInt((selectCountEl && selectCountEl.value) || '20', 10);
      if (Number.isNaN(v)) return 20;
      return Math.max(2, Math.min(36, v));
    }

    // Decorative dots
    const wheel = document.getElementById("wheel");
    const dotCount = 36, radius = 120;
    for (let i = 0; i < dotCount; i++) {
      const angle = (2 * Math.PI / dotCount) * i;
      const dot = document.createElement("div");
      dot.className = "dot";
      dot.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle)*radius}px, ${Math.sin(angle)*radius}px)`;
      wheel.appendChild(dot);
    }

    // Maps init
    function initApp() {
      const tempMap = new google.maps.Map(document.createElement("div"));
      service = new google.maps.places.PlacesService(tempMap);
      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById("map"), { center: { lat: 24.8138, lng: 120.9675 }, zoom: 12 });
      marker = new google.maps.Marker({ map });
    }

    function geocodeDistrict(name) {
      return new Promise((resolve) => {
        if (boundsCache[name]) return resolve(boundsCache[name]);
        geocoder.geocode({ address: `${name}, 台灣` }, (results, status) => {
          if (status === google.maps.GeocoderStatus.OK && results && results[0]) {
            const g = results[0].geometry;
            const out = { bounds: g.bounds || g.viewport || null, center: g.location };
            boundsCache[name] = out;
            resolve(out);
          } else {
            resolve(null);
          }
        });
      });
    }

    function fetchRestaurantsV2() {
      restaurants = [];
      document.getElementById("restaurantList").innerHTML = "";
      if (selected.size === 0) { alert("請先選擇至少一個地區"); return; }
      const pool = getActiveKeywords();
      if (!pool.length) { alert("請輸入至少一個關鍵字"); return; }

      const tasks = [];
      const usedKwsSet = new Set();
      Array.from(selected).forEach(d => pool.forEach(kw => { tasks.push({ d, kw }); usedKwsSet.add(kw); }));

      const seen = new Set();
      let done = 0;
      tasks.forEach(({ d, kw }) => {
        geocodeDistrict(d).then(info => {
          const center = info && info.center ? info.center : null;
          const bounds = info && info.bounds ? info.bounds : null;

          if (!center) {
            const query = `${kw} restaurant ${d}`;
            service.textSearch({ query, region: 'TW' }, (tRes, tStatus) => {
              if (tStatus === google.maps.places.PlacesServiceStatus.OK && Array.isArray(tRes)) {
                for (const r of tRes) {
                  if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
                }
              }
              if (++done === tasks.length) finalizeWheel();
            });
            return;
          }

          service.nearbySearch({ location: center, radius: 6000, type: 'restaurant', keyword: kw }, (results, status, pagination) => {
            if (status === google.maps.places.PlacesServiceStatus.OK && Array.isArray(results)) {
              for (const r of results) {
                const inside = !bounds || (r.geometry && r.geometry.location && bounds.contains(r.geometry.location));
                if (!inside) continue;
                if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
              }
            }
            if (pagination && pagination.hasNextPage) {
              setTimeout(() => pagination.nextPage(), 300);
            } else {
              if ((!results || results.length === 0)) {
                const query = `${kw} restaurant ${d}`;
                service.textSearch({ query, location: center, radius: 6000, region: 'TW' }, (tRes, tStatus) => {
                  if (tStatus === google.maps.places.PlacesServiceStatus.OK && Array.isArray(tRes)) {
                    for (const r of tRes) {
                      const inside2 = !bounds || (r.geometry && r.geometry.location && bounds.contains(r.geometry.location));
                      if (!inside2) continue;
                      if (r.place_id && !seen.has(r.place_id)) { seen.add(r.place_id); restaurants.push(r); }
                    }
                  }
                  if (++done === tasks.length) finalizeWheel();
                });
              } else {
                if (++done === tasks.length) finalizeWheel();
              }
            }
          });
        }).catch(() => { if (++done === tasks.length) finalizeWheel(); });
      });

      function finalizeWheel() {
        shuffle(restaurants);
        const count = (typeof getSelectCount === 'function') ? getSelectCount() : 20;
        restaurants = restaurants.slice(0, Math.max(1, Math.min(count, restaurants.length)));
        assignSlicesAndColors();
        const usedKws = Array.from(usedKwsSet);
        const kwText = usedKws.length ? usedKws.join(', ') : 'default';
        alert(`找到可選餐廳: ${restaurants.length} 家\n關鍵字: ${kwText}`);
      }
    }

    function assignSlicesAndColors() {
      if (!restaurants.length) return;
      const slice = 360 / restaurants.length;
      const list = document.getElementById("restaurantList");
      list.innerHTML = "";
      const parts = [];
      restaurants.forEach((r, i) => {
        const color = colors[i % colors.length];
        const startAngle = i * slice, endAngle = (i + 1) * slice;
        r._color = color; r._sliceStart = startAngle; r._sliceEnd = endAngle; r._sliceCenter = startAngle + slice / 2;
        parts.push(`${color} ${startAngle}deg ${endAngle}deg`);
        const li = document.createElement("li"); li.textContent = r.name; list.appendChild(li);
      });
      wheel.style.background = `conic-gradient(${parts.join(',')})`;
    }

    function spin() {
      if (!restaurants.length) { alert("請先取得餐廳"); return; }
      const r = restaurants[Math.floor(Math.random() * restaurants.length)];
      const targetDeg = 3600 + (360 - r._sliceCenter);
      wheel.style.transform = `rotate(${targetDeg}deg)`;
      setTimeout(() => {
        const url = r.place_id ? `https://www.google.com/maps/place/?q=place_id:${r.place_id}` : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name)}`;
        document.getElementById("result").innerHTML = `
          <h2 class="text-xl font-bold" style="color:${r._color};">${r.name}</h2>
          <p>${r.vicinity || r.formatted_address || ''}</p>
          <a href="${url}" target="_blank" class="text-blue-600 underline">在 Google 地圖開啟</a>`;
        showOnMap(r);
      }, 3200);
    }

    function showOnMap(place) {
      if (!place.geometry || !place.geometry.location) return;
      map.setCenter(place.geometry.location);
      marker.setPosition(place.geometry.location);
      marker.setTitle(place.name);
    }
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHJAKYPP4peYR5TIVm69256nqJ01gat9Q&libraries=places&callback=initApp"></script>
</body>
</html>